Notes
-----------------------

Packages install by pip3 in the host machine cannot be accessed by python3 in virtualEnv.

(i think) by default, the current directory "./" is searched too, besides the paths in the sys.path list.


About django-admin and manage.py
-------------------------------------

Reference: https://docs.djangoproject.com/en/1.11/ref/django-admin/

django-admin is django's command-line utility for administrative tasks.

Manage.py does the same thing as django-admin but takes care of a few more things:  
	- it puts your project's package on sys.path  
	- it sets the DJANGO_SETTINGS_MODULE env variable so that it points to your project's settings.py file

(in short, manage.py is a wrapper script to use django-admin.)

If working in a single django project, it is easier to use manage.py.  
If need to switch between multiple django settings files, use django-admin with DJANGO_SETTINGS_MODULE or the --settings command line option.

Usage:  
	django-admin <command> [options]  
	manage.py <command> [options]  
	python -m django <command> [options]  


about settings.py
------------------------

Based on https://docs.djangoproject.com/en/1.11/topics/settings/,
we need to "export DJANGO_SETTINGS_MODULE=mysite.settings" 
before running "django-admin runserver".  
Also, this mysite.settings has be be searchable by python.  
(Or: django-admin runserver --settings=mysite.settings)

actually, manage.py is exactly trying to help us simplfy this.  
In the file, there is this line:  
os.environ.setdefault("DJANGO_SETTINGS_MODULE", "mysite.settings")  
which is obviously setting the environment variable (inside this runtime only)

there is a default settings.py file.  
E.g. in my case, it can be found at ~/.virtualenvs/django2/lib/python3.5/site-packages/django/conf/global_settings.py

django loads global_settings.py first, and then loads settings from the specified settings file, overriding the global settings as necessary.

You can also use default values that come from other place.
Need to call configure().  
Use exactly one of either configure() or DJANGO_SETTINGS_MODULE. Not both, and not neither.


Tutorial
---------------------

Link: https://docs.djangoproject.com/en/1.11/intro/tutorial01/


to create a superuser
-------------------------------
Example:

```
>>> from django.contrib.auth.models import User
>>> user=User.objects.create_user('foo', password='bar')
>>> user.is_superuser=True
>>> user.is_staff=True
>>> user.save()
```

some notes
-------------------------

./manage.py sqlmigrate polls 0001  
shows the exact sql commands that will be executed from the polls/migrations/0001_initial.py  
(however, still need to run "./manage.py migrate" to do the real creation or modification of tables.)

One example to use filter: Choice.objects.filter(question__pub_date__year=current_year)  
note that in the (), just imagine '__' as '.', so in the (), it is like question.pub_date.year=current_year.  
The reason that we need to use __ is that we want to specify the relationship == sth, not a variable = sth 
(or another way to view this is that this 'variable' is an relationship object..)

Initially, need to create a superuser in order to use the admin page.
Python manage.py createsuperuser

order_by() can be place anywhere (doesn't matter before or or after fitler ),
becasue ultimately will be put at nearly last in the sql command generated by django.  
It is okay to use order_by() twice on the same filter -- the sql command won't do it twice.


Regarding foreignkey
---------------------------

Two model classes: Question and Choice.
In the choice class, one field is ForeignKey(Question).

To create choices for a question, interestingly, it is not that a question has several fields called choice.
But it is that multiple Choice objects that have the same foreign key Question...

Although Question class has no indication of having relation with the Choice class, 
django is smart enough to let use get the choices objects that have this question as foreignkey from a Question object!
To get this set, use q.choice_set.all()  
if there is a Answer model class that has Question as foreign key, then to get the answer set for q, use q.answer_set.all()  
(i.e. the function name will be generated dynamically by django..) 

To create a choice for a question in shell: c = q.choice_set.create(choice_text='Just hacking again', votes=0)  
c is a Choice object.  
To get the question from c, use: c.question (question is a field in the Choice class)

regarding url
-------------------------

Example: url(r'^(?P<question_id>[0-9]+)/results/$', views.results, name='results')

how to interpret this?  
Firstly, the link accepted has to be something like url_prefix/${question_id}/results, where ${question_id} has to be a number.  
The parent url.py file will strip off the url_prefix and pass whatever remaining to this url.py file. 
Then if the remaining part matches r'^(?P<question_id>[0-9]+)/results/$', then the specific python function will be called.  
The (?P<question_id>[0-9]+) specifies what is expected. [0-9]+ is a regular expression to indicate it must be digits.
The ?P<question_id> defines the variable name that the specific function can use to get the number.  
Therefore, in the views.results function, the header is  
def results(request, question_id)

ultimately, the call to results() looks like:  
results(request = <HttpRequest object>, question_id = '34')

in the url() funtion, why do we need " the name='results' "?  
This can be used for html file to link to this url in a more flexible way.  
Imagine if we change anything in this url, then the hard-coded link in a html file will fail.  
Using the name instead, we can let django dynamically generate the correct url in the html file.  
In the html file, the link should look like:  
	<li><a href="{% url 'detail' question.id %}">{{ question.question_text }}</a></li>  
which allows points to the url of the link created by  
url(r'^(?P<question_id>[0-9]+)/$', views.detail, name='detail') 
in polls/urls.py file.

Note that the syntax in the html is independent from the url in urls.py.  
So we can change the url anyway, as long as we keep the (?P<question_id>[0-9]+) in the modified url, the thing in html will be resolved to the updated link.

However, one issue is that this name of url is flat.  
If there are two urls in two apps that are both named 'details', django won't know which one to be used.  
To solve this, add "app_name = 'APP_NAME'" in the urls.py in each app.  
Then in the html, use {% url 'polls:detail' .... %} instead of {% url 'details' ... %}



regarding views
-------------------------------

Each view (function) is responsible for doing one of 2 things:  
	- return an HttpResponse object  
	- or raise an exception like Http404

regarding templates
------------------------------

By default django looks for a 'templates' subdirectory in each of the INSTALLED_APPS.  
However, in the templates folder, recommended to create another folder with the same name as the app.  
E.g. for app polls, there will be a directory: polls/templates/polls/  
the reason is that all the template folders in each app will be treated as flat.
So better add another layer to make the template file path unique.

{{  }} is to access variable and its attributes..  
E.g. {{ question.question_text }} : django does a dictionary lookup on the object question; 
if failed, it will do an attribute lookup, and so on.

{%   %} is for method calling. 
The syntax inside is similar to python, but not entirely the same.  
Better to treat it as a new scripting language.


Generic view
-------------------------------------

This is a super lazy way of writing views.

There are 2 common usage:  
	1. get an object and display the detailed view of it  
	2. get a list of objects and display it in a list

generic view has ready-to-be-used classes for both.  
One is the DetailView and the other ListView.  

A class inherited from DetailView will expect a 'pk' variable defined by the url.  
It also needs to be told what the model is.  
Finally, it will use a default template with name "app/modelName_detail.html" but we can override it by defining the template_name.  
One example:  
```
class DetailView(generic.DetailView):
    model = Question
    template_name = 'polls/detail.html'
```

The listview expect a queryset, which can be done by defining the "def get_queryset(self)" method inside the class.  
It has a default template_name and context_object_name, but both can be overridden.  
Btw context_object_name is the name of the list used by the template.  
One example:  
```
# note that this is list view
# list view is the concept of displaying a list of objects
class IndexView(generic.ListView):
        # if i don't specify a template name, the default name will be polls/question_list.html
        template_name = 'polls/index.html'
        # by default the context_object_name in template is "question_list", but we can override it 
        context_object_name = 'latest_question_list'

        def get_queryset(self):
                """Return the last five published questions."""
                return Question.objects.order_by('-pub_date')[:5]

```

unit tests
--------------------------

There is a built-in x-unit test for django.  

To test polls app, use: ./manage.py test polls

in the polls/tests.py file, we can test both models and views.  
To test model, it is to create a new object and test if the method behaves what is expected.

To test view, we likely need to create new object and then call the url.  
The interesting thing is that the object created in this way won't be saved to the real database.  
Not sure if they save first and then delete or it simply never creates anything in database.

Anyway, after creating the object, and then call the respective url,
then check if the status code is what is expected.
More importantly, we can get back the "variable" used in the template, and then check if this variable is correct.  
Example:
```
        def test_two_past_questions(self):
                """
                the questions index page may display multiple questions
                """
                create_question(question_text = "Past question 1.", days=-30)
                create_question(question_text = "Past question 2.", days=-5)
                response = self.client.get(reverse('polls:index'))
                self.assertQuerysetEqual(
                        response.context['latest_question_list'],
                        ['<Question: Past question 2.>', '<Question: Past question 1.>']
                )

```
the above example creates 2 questions, and then get the response.
From the response we extract the queryset 'latest_question_list' (this name is decided by the template),
and then we can check if this queryset is what have been expected.

In fact, after running test, the screen says: Destroying test database for alias 'default',
which means that it does create a database, but it will destroy at the end


about static files
-----------------------------

Like template, create a directory static/polls in the polls folder.  
Then a static file in this directory can be referred as "polls/static_filename".  
The tag {% static "polls/style.css" %} will generate the absolute link to the sytle.css in this example.  
One example in index.html:  
```
{% load static %}
<link rel="stylesheet" type="text/css" href="{% static 'polls/style.css' %}">
```

while the style.css looks like:  
```
li a {
	color: green;
}

body {
	background: white url("images/background.jpg") no-repeat right bottom;
}
```

display models in admin page
-----------------------------------

In each app, there is a admin.py page. 
Just register the model.  
One example:  
```
from django.contrib import admin
from .models import Question, Choice

admin.site.register(Question)
admin.site.register(Choice)
```
the default admin display for a model can be changed.  
One example:  
```
# this class will be passed into the admin.site.register() function
# in this particular case, the order of display will be pub_date and then question_text (default behaviour is the other way)
class QuestionAdmin(admin.ModelAdmin):
	# fields = ['pub_date', 'question_text'] # this changes the order of display of fields

	# for fieldsets, the first element in each tuple is the title of the fieldset, 
	# while the 2nd is the list of fields under this title
	fieldsets = [
		(None, 			{'fields': ['question_text']}),
		('Date information', 	{'fields': ['pub_date']})
	]
	# this tells Django that Choice objects are edited on the Question admin page;
	# by default provide enough fields for 3 choices
	inlines = [ChoiceInline]

	# this controls what to display on the list of questions
	# interestingly, even the method can be added here..
	list_display = ('question_text', 'pub_date', 'was_published_recently')

	list_filter = ['pub_date']

	search_fields = ['question_text']

#admin.site.register(Question) # this uses the default admin view
admin.site.register(Question, QuestionAdmin)

```

The above example changes the order of the fields, groups some fields under one title,
add the model that uses it as a foreign key to its display,
changes the list display when go to the model's admin view,
and also add search box.



Log all sql commands
-------------------------------

Reference: https://stackoverflow.com/questions/4375784/log-all-sql-queries  
add the following codes to settings.py:  
```
LOGGING = {
    'version': 1,
    'filters': {
        'require_debug_true': {
            '()': 'django.utils.log.RequireDebugTrue',
        }
    },
    'handlers': {
        'console': {
            'level': 'DEBUG',
            'filters': ['require_debug_true'],
            'class': 'logging.StreamHandler',
        }
    },
    'loggers': {
        'django.db.backends': {
            'level': 'DEBUG',
            'handlers': ['console'],
        }
    }
}
```


how to solve if admin page is too slow
--------------------------------------------

Reference: https://stackoverflow.com/questions/31459078/django-loading-many-to-many-relationship-admin-page-is-so-slow
